# docker-compose.yml
# Part C fixes:
#   C1: removed deprecated 'version' key (Compose v2 ignores it with a warning)
#   C2: added healthcheck on backend — frontend waits for FastAPI to be ready
#       before nginx starts proxying, preventing 502 on first page load
#   C3: use python urllib for healthcheck — curl not present in python:3.10-slim
#   C4: increased healthcheck interval 10s→30s — 10s was generating excessive
#       uvicorn access log noise with no operational benefit post-startup

services:
  backend:
    build: ./backend
    container_name: trishul-snmp-backend
    env_file:
      - .env
    ports:
      - "8000:8000"
      - "${SNMP_PORT:-1061}:${SNMP_PORT:-1061}/udp"
      - "${TRAP_PORT:-1162}:${TRAP_PORT:-1162}/udp"
    volumes:
      - ./backend/data:/app/data
      - ./backend/data/mibs:/usr/share/snmp/mibs/custom
    environment:
      - PYTHONUNBUFFERED=1
      # Application Metadata
      - APP_NAME=${APP_NAME:-Trishul SNMP Studio}
      - APP_VERSION=${APP_VERSION:-1.2.3}
      - APP_AUTHOR=${APP_AUTHOR:-Sumit Dhaka}
      - APP_DESCRIPTION=${APP_DESCRIPTION:-Network Management & SNMP Utilities}
      # SNMP Settings
      - SNMP_PORT=${SNMP_PORT:-1061}
      - SNMP_COMMUNITY=${SNMP_COMMUNITY:-public}
      - TRAP_PORT=${TRAP_PORT:-1162}
      # Security
      - SESSION_TIMEOUT=${SESSION_TIMEOUT:-3600}
      # CORS
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:8080}
      # Auto-Start flags (Part A)
      - AUTO_START_SIMULATOR=${AUTO_START_SIMULATOR:-true}
      - AUTO_START_TRAP_RECEIVER=${AUTO_START_TRAP_RECEIVER:-true}
    # C2/C3/C4: healthcheck using python stdlib — no curl needed in slim image.
    # interval: 30s is plenty for a running container; start_period handles startup.
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: always

  frontend:
    build: ./frontend
    container_name: trishul-snmp-frontend
    ports:
      - "8080:80"
    # C2: wait for backend to pass healthcheck before starting nginx
    depends_on:
      backend:
        condition: service_healthy
    restart: always
